<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CASINO LEGEND: V15 IMMORTAL MUSIC</title>
    <style>
        /* ===== VARIABLES ===== */
        :root {
            --bg: #000000;
            --gold: #ffd700;
            --demon: #ff003c;
            --glitch: #00ffff;
            --joker: #a855f7;
            --dragon: #00ff00;
            --phoenix: #ff8c00;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: #020202; color: #fff; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column; align-items: center;
        }

        /* LAYERS */
        .nebula-bg { position: fixed; inset: 0; z-index: -2; background: radial-gradient(circle at 50% 50%, #1a0b2e 0%, #000 90%); }
        #particleCanvas { position: fixed; inset: 0; z-index: -1; pointer-events: none; opacity: 0.6; }
        #lightningCanvas { position: fixed; inset: 0; z-index: 200; pointer-events: none; mix-blend-mode: screen; }
        
        /* DIMMING OVERLAY */
        .dim-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0); z-index: 140; 
            opacity: 0; transition: opacity 0.05s ease-out; pointer-events: none;
        }
        .dim-overlay.active { opacity: 0.7; }

        /* START & LOGIN */
        #startScreen, #loginScreen { position: fixed; inset: 0; z-index: 9999; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #loginScreen { background: rgba(0,0,0,0.95); z-index: 5000; display: none; }
        
        .btn-start {
            padding: 20px 50px; font-size: 1.5rem; font-weight: 900; background: linear-gradient(45deg, var(--demon), #500);
            color: #fff; border: 3px solid #fff; border-radius: 50px; box-shadow: 0 0 50px var(--demon); cursor: pointer; animation: pulse 1s infinite;
        }

        /* CUSTOM CONFIRM MODAL */
        #confirmModal {
            position: fixed; inset: 0; z-index: 6000; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px);
            display: none; align-items: center; justify-content: center;
        }
        .confirm-box {
            width: 300px; background: linear-gradient(135deg, #222, #000); 
            border: 2px solid var(--gold); border-radius: 15px; padding: 25px; 
            text-align: center; box-shadow: 0 0 30px rgba(255, 215, 0, 0.2);
            transform: scale(0.9); animation: popIn 0.2s forwards;
        }
        .confirm-title { color: var(--gold); font-size: 1.2rem; font-weight: 900; margin-bottom: 10px; text-transform: uppercase; }
        .confirm-msg { color: #ccc; margin-bottom: 25px; font-size: 0.9rem; line-height: 1.4; }
        .confirm-actions { display: flex; gap: 10px; }
        .btn-yes { flex: 1; background: var(--gold); color: #000; border: none; padding: 12px; font-weight: 800; border-radius: 8px; cursor: pointer; }
        .btn-no { flex: 1; background: #333; color: #fff; border: 1px solid #555; padding: 12px; font-weight: 800; border-radius: 8px; cursor: pointer; }

        /* UI TOP BAR */
        .top-bar { 
            width: 100%; max-width: 500px;
            padding: 15px; background: linear-gradient(180deg, #222, #111); border-bottom: 2px solid #444; 
            display: flex; justify-content: space-between; align-items: center; z-index: 100; box-shadow: 0 5px 20px #000; 
        }
        .stat-pill { background: #000; border: 1px solid #333; padding: 8px 15px; border-radius: 8px; font-weight: bold; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; box-shadow: inset 0 0 10px #111; }
        .btn-icon { background: #333; border: 1px solid #555; color: #fff; width: 42px; height: 42px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* ===== MACHINE FRAME ===== */
        .stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; perspective: 1000px; width: 100%; }
        
        .machine-casing {
            position: relative; padding: 15px; width: 340px; 
            background: linear-gradient(135deg, #2a2a2a 0%, #111 40%, #000 100%);
            border-radius: 20px; border: 4px solid #444;
            box-shadow: 0 0 0 5px #111, 0 0 0 8px #333, 0 0 60px rgba(0,0,0,0.8);
            margin-bottom: 20px; transition: 0.3s; z-index: 10;
        }
        
        .machine-casing.boost-active { border-color: var(--glitch); animation: boostPulse 1.5s infinite alternate; }
        .machine-casing.god-active { border-color: var(--target-color) !important; box-shadow: 0 0 80px var(--target-color), inset 0 0 30px var(--target-color) !important; animation: shake 0.5s infinite !important; }
        .machine-casing.glow-demon { box-shadow: 0 0 60px var(--demon); border-color: var(--demon); }

        .screw { position: absolute; width: 12px; height: 12px; background: radial-gradient(circle, #555, #222); border-radius: 50%; box-shadow: inset 0 0 2px #000; }
        .tl { top: 10px; left: 10px; } .tr { top: 10px; right: 10px; }
        .bl { bottom: 10px; left: 10px; } .br { bottom: 10px; right: 10px; }

        .slot-window {
            width: 100%; height: 450px; 
            background: #000; 
            border: 4px solid #222; border-radius: 10px;
            box-shadow: inset 0 0 30px #000;
            display: flex; gap: 4px; padding: 4px; 
            position: relative; overflow: hidden;
        }
        
        .payline { position: absolute; top: 50%; left: 0; right: 0; height: 4px; background: rgba(255,0,0,0.4); z-index: 20; transform: translateY(-50%); pointer-events: none; box-shadow: 0 0 10px red; }

        .reel { flex: 1; background: #080808; border-radius: 4px; border: 1px solid #1a1a1a; overflow: hidden; position: relative; mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent); }
        .reel-strip { display: flex; flex-direction: column; align-items: center; will-change: transform; }
        
        .slot-icon { height: 140px; width: 100%; display: flex; align-items: center; justify-content: center; font-size: 70px; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }
        .blur-spin { filter: blur(4px); transform: scaleY(1.2); opacity: 0.8; }

        /* CONTROLS */
        .controls { display: grid; grid-template-columns: 1fr 100px 1fr; gap: 10px; width: 340px; align-items: end; position: relative; z-index: 10; }
        .btn-act { border: none; border-radius: 12px; color: #fff; cursor: pointer; font-weight: 800; text-transform: uppercase; box-shadow: 0 5px 0 #000; transition: 0.1s; }
        .btn-act:active { transform: translateY(5px); box-shadow: 0 0 0 #000; }
        .btn-boost { height: 60px; background: #333; color: #888; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn-boost.active { background: linear-gradient(45deg, #06b6d4, #0891b2); color: #fff; box-shadow: 0 0 20px var(--glitch); border: 1px solid #fff; }
        .btn-spin { width: 90px; height: 90px; border-radius: 50%; margin: 0 auto; background: radial-gradient(circle at 30% 30%, var(--gold), #b8860b); border: 4px solid #8a6000; box-shadow: 0 0 50px rgba(255,215,0,0.2), 0 10px 0 #3e2b00; color: #221; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 0.1s; z-index: 10; }
        .btn-spin:active { transform: translateY(10px); box-shadow: 0 0 0 #3e2b00; }
        .btn-spin:disabled { filter: grayscale(1); cursor: not-allowed; }
        .btn-multi { height: 60px; background: linear-gradient(45deg, #7c3aed, #4c1d95); display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.2; }

        /* POPUPS */
        #jackpotPopup { position: fixed; inset: 0; z-index: 300; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; animation: zoomIn 0.3s; }
        .jackpot-card { transform: scale(1.5); box-shadow: 0 0 100px var(--glow); animation: float 2s infinite ease-in-out; pointer-events: none; }
        .jackpot-text { font-size: 3rem; font-weight: 900; text-transform: uppercase; margin-bottom: 30px; text-shadow: 0 0 20px #fff; color: #fff; text-align: center; animation: pulse 0.2s infinite; }

        .result-layer { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 200; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .card-scroller { width: 100%; overflow-x: auto; padding: 40px 0; display: flex; scroll-behavior: smooth; }
        .card-scroller::-webkit-scrollbar { display: none; }
        .card-track { display: flex; gap: 25px; padding: 0 50vw; width: max-content; }

        /* CARD STYLES */
        .card { width: 220px; height: 320px; background: #151515; border: 3px solid #333; border-radius: 18px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; flex-shrink: 0; transform: scale(0.8); opacity: 0.5; transition: 0.3s; overflow: hidden; --glow: #555; }
        .card.active { transform: scale(1.1); opacity: 1; z-index: 10; border-color: var(--glow); box-shadow: 0 0 40px var(--glow), inset 0 0 20px var(--glow); }
        .t-joker { --glow: var(--joker); background: linear-gradient(135deg, #200020, #000); }
        .t-dragon { --glow: var(--dragon); background: linear-gradient(135deg, #002000, #000); }
        .t-phoenix { --glow: var(--phoenix); background: linear-gradient(135deg, #201000, #000); }
        .t-ice { --glow: var(--ice); box-shadow: 0 0 25px var(--ice) !important; }
        
        .fx-shiny { --glow: #fff; animation: shinyBorder 2s infinite; }
        .fx-shiny::after { content:''; position:absolute; inset:-100%; background:linear-gradient(45deg,transparent,rgba(255,255,255,0.8),transparent); animation:shinePass 1.5s infinite; transform:rotate(45deg); pointer-events:none; }
        .fx-glitch { --glow: var(--glitch); animation: glitchBorder 0.2s infinite; background: repeating-linear-gradient(0deg, #000, #000 2px, #002 2px, #002 4px); }
        .fx-glitch .card-img { animation: glitchImg 0.2s infinite steps(2); filter: drop-shadow(-3px 0 red) drop-shadow(3px 0 blue); }
        .fx-demon { --glow: var(--demon); border-width: 5px; background: #000; box-shadow: 0 0 60px var(--demon), 0 0 100px #800000, inset 0 0 60px var(--demon) !important; animation: demonShake 2s infinite, pulseRed 0.4s infinite alternate; }
        .fx-demon .card-img { animation: demonFloat 1s infinite alternate; filter: drop-shadow(0 0 30px #ff0000); }

        .card-img { font-size: 80px; margin-bottom: 15px; z-index: 2; transition: transform 0.3s; }
        .card-name { font-weight: 900; font-size: 1rem; text-transform: uppercase; z-index: 2; text-align: center; text-shadow: 0 2px 5px #000; }
        .mut-badge { position: absolute; top: 10px; right: 10px; padding: 4px 8px; border-radius: 4px; font-weight: 900; font-size: 0.7rem; text-transform: uppercase; z-index: 5; color: #000; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 500; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { width: 90%; max-width: 450px; background: #1a1a1a; border: 2px solid #444; border-radius: 15px; padding: 20px; display: flex; flex-direction: column; max-height: 80vh; }
        .modal-body { overflow-y: auto; }
        .shop-grid, .inv-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .inv-grid { grid-template-columns: repeat(3, 1fr); }
        .shop-item { background: #222; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #333; cursor: pointer; transition: 0.2s; }
        .shop-item:hover { border-color: var(--gold); background: #2a2a2a; transform: scale(1.02); }
        .inv-card { aspect-ratio: 1; background: #1a1a1a; border: 2px solid #333; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; cursor: pointer; transition: 0.2s; --glow: #333; }
        .inv-card:hover { transform: scale(1.05); border-color: var(--glow); box-shadow: 0 0 20px var(--glow); z-index: 5; }
        
        #previewOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 600; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #previewCont { transform: scale(1.5); pointer-events: none; }
        #sellActions { margin-top: 60px; display: flex; gap: 10px; z-index: 601; pointer-events: auto; }

        @keyframes shinePass { 0%{left:-100%} 100%{left:200%} }
        @keyframes glitchImg { 0%{transform:translate(0)} 20%{transform:translate(-2px,2px)} 40%{transform:translate(2px,-2px)} }
        @keyframes demonShake { 0%{transform:rotate(0)} 25%{transform:rotate(1deg)} 75%{transform:rotate(-1deg)} }
        @keyframes demonFloat { 0%{transform:translateY(0)} 100%{transform:translateY(-10px)} }
        @keyframes pulseRed { 0%{box-shadow:0 0 60px var(--demon)} 100%{box-shadow:0 0 120px var(--demon)} }
        @keyframes starsAnim { 100%{background-position: 0 1000px} }
        @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.05)} }
        @keyframes shake { 0%{transform:translate(0)} 25%{transform:translate(-5px, 5px)} 75%{transform:translate(5px, -5px)} 100%{transform:translate(0)} }
        @keyframes zoomIn { from {transform:scale(0)} to {transform:scale(1)} }
        @keyframes float { 0%, 100% {transform:scale(1.5) translateY(0)} 50% {transform:scale(1.5) translateY(-20px)} }
        @keyframes boostPulse { 0% { box-shadow: 0 0 30px var(--glitch), inset 0 0 10px rgba(0, 255, 255, 0.2); } 100% { box-shadow: 0 0 60px var(--glitch), inset 0 0 30px rgba(0, 255, 255, 0.5); } }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    </style>
</head>
<body>

    <div class="nebula-bg"><div class="stars"></div></div>
    <canvas id="particleCanvas"></canvas>
    <canvas id="lightningCanvas"></canvas>
    <div class="dim-overlay" id="dimOverlay"></div>

    <div id="confirmModal">
        <div class="confirm-box">
            <div class="confirm-title">KONFIRMASI</div>
            <div class="confirm-msg" id="confirmMsg">...</div>
            <div class="confirm-actions">
                <button class="btn-yes" onclick="processTransaction()">YA, LANJUT</button>
                <button class="btn-no" onclick="closeConfirm()">BATAL</button>
            </div>
        </div>
    </div>

    <audio id="bgm1" src="https://f.top4top.io/m_36637n1e00.mp3"></audio>
    <audio id="bgm2" src="https://f.top4top.io/m_36637n1e00.mp3"></audio>
    
    <audio id="winAudio" src="https://l.top4top.io/m_3663vc4970.mp3"></audio>
    <audio id="winAudio2" src="https://l.top4top.io/m_3663vc4970.mp3"></audio>
    
    <audio id="thunderAudio" src="https://a.top4top.io/m_36636a1cl0.mp3"></audio>
    <audio id="thunderAudio2" src="https://a.top4top.io/m_36636a1cl0.mp3"></audio>

    <div id="startScreen">
        <h1 style="font-size:3.5rem; margin-bottom:20px; color:var(--demon); text-shadow:0 0 30px #f00; text-transform:uppercase; text-align:center;">GOD PERFECT<br><span style="font-size:1.5rem; color:#fff;">V15 IMMORTAL</span></h1>
        <p style="color:#aaa; font-size:0.8rem; margin-bottom:20px">LOADING ASSETS...</p>
        <button class="btn-start" onclick="startGame()">üîä START ENGINE</button>
    </div>

    <div id="loginScreen">
        <div style="background:#111; padding:30px; border:2px solid var(--gold); border-radius:20px; width:300px; text-align:center; box-shadow: 0 0 50px rgba(255,215,0,0.2);">
            <h2 style="color:var(--gold); margin-bottom:15px;">PLAYER ID</h2>
            <input type="text" id="username" placeholder="USERNAME" style="width:100%; padding:15px; background:#000; border:1px solid #444; color:#fff; text-align:center; border-radius:10px; margin-bottom:15px;">
            <button class="btn-act" style="width:100%; background:var(--gold); color:#000; padding:15px; font-weight:bold;" onclick="doLogin()">MASUK</button>
        </div>
    </div>

    <div class="top-bar">
        <div style="display:flex; gap:10px;">
            <div class="stat-pill" style="border-color:#4ade80">üíµ <span id="uiCash" style="color:#4ade80">0</span></div>
            <div class="stat-pill" style="border-color:var(--gold)">ü™ô <span id="uiCoins" style="color:var(--gold)">0</span></div>
            <div class="stat-pill" id="luckStatus" style="display:none; color:var(--demon); border-color:var(--demon); background:#300; box-shadow:0 0 20px var(--demon);">üòà POTION</div>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-icon" onclick="showModal('shopModal')">üõí</button>
            <button class="btn-icon" onclick="openInv('all')">üéí</button>
        </div>
    </div>

    <div class="stage">
        <div class="machine-casing" id="machineBody">
            <div class="screw tl"></div><div class="screw tr"></div><div class="screw bl"></div><div class="screw br"></div>
            <div class="slot-window">
                <div class="payline"></div>
                <div class="reel" id="reel1"><div class="reel-strip" id="strip1"></div></div>
                <div class="reel" id="reel2"><div class="reel-strip" id="strip2"></div></div>
                <div class="reel" id="reel3"><div class="reel-strip" id="strip3"></div></div>
            </div>
        </div>
        <div class="controls">
            <button class="btn-act btn-boost" id="btnBoost" onclick="toggleBoost()"><span>‚ö° BOOST</span><span style="font-size:0.6rem; margin-top:5px; opacity:0.7">5K COINS</span></button>
            <button class="btn-spin" id="spin1" onclick="spinSequence(1)"><span style="font-size:1.2rem; font-weight:900;">SPIN</span><span style="font-size:0.7rem; font-weight:bold; margin-top:2px;">100 C</span></button>
            <button class="btn-act btn-multi" id="spin5" onclick="spinSequence(5)"><span>üî• 5x AUTO</span><span style="font-size:0.6rem; margin-top:5px; opacity:0.7">500 COINS</span></button>
        </div>
    </div>

    <div id="jackpotPopup" onclick="closeJackpot()"><div class="jackpot-text" id="jackpotTitle">GOD MODE!</div><div id="jackpotCont"></div><div style="margin-top:50px; color:#fff; font-size:1rem; opacity:0.8; animation:pulse 0.5s infinite;">TAP ANYWHERE TO CLAIM</div></div>
    <div class="result-layer" id="resultLayer"><div class="card-scroller" id="cardScroller"><div class="card-track" id="cardTrack"></div></div><button class="btn-act btn-multi" style="width:200px; margin-top:30px; font-size:1.2rem; box-shadow:0 0 20px var(--joker);" onclick="closeResult()">AMBIL ITEM</button></div>
    <div id="previewOverlay" onclick="closePreview()"><div id="previewContent" onclick="event.stopPropagation()"><div id="previewCont"></div><div id="sellActions" style="margin-top:20px; display:flex; justify-content:center;"></div></div><div style="margin-top:30px; color:#888; font-size:0.8rem;">TAP BACKGROUND TO CLOSE</div></div>
    
    <div class="modal" id="shopModal"><div class="modal-box"><div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3>SHOP</h3><button onclick="hideModal('shopModal')" class="btn-icon">√ó</button></div><div class="modal-body"><input type="text" id="codeInput" placeholder="KODE REDEEM" style="width:100%; padding:12px; background:#000; border:2px solid #333; color:#fff; margin-bottom:15px; border-radius:10px;"><button class="btn-act" style="width:100%; background:var(--demon); padding:12px; margin-bottom:25px;" onclick="redeem()">TUKAR KODE</button><h4 style="color:var(--gold); margin-bottom:10px;">BELI KOIN (Pakai Saldo)</h4><div class="shop-grid" id="coinGrid"></div><h4 style="color:#4ade80; margin-bottom:10px;">TOP UP SALDO</h4><div class="shop-grid" id="cashGrid"></div></div></div></div>
    <div class="modal" id="invModal"><div class="modal-box"><div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3>TAS</h3><button onclick="hideModal('invModal')" class="btn-icon">√ó</button></div><div class="modal-body"><div style="display:flex; gap:10px; margin-bottom:15px;"><button class="btn-act" style="flex:1; background:#333; padding:10px;" onclick="openInv('all')">SEMUA</button><button class="btn-act" style="flex:1; background:var(--demon); padding:10px;" onclick="openInv('mutant')">MUTASI</button></div><button class="btn-act" style="width:100%; background:#800; padding:12px; margin-bottom:20px; border:2px solid #f00;" onclick="sellTrash()">JUAL SEMUA SAMPAH</button><div class="inv-grid" id="invGrid"></div></div></div></div>

    <script>
        const ITEMS = [
            { id: 1, name: "TONGKAT PATAH", tier: 0, baseVal: 5, emoji: "ü™Ñ", color: "#555", weight: 4000 },
            { id: 2, name: "ABU KUTUKAN", tier: 0, baseVal: 5, emoji: "üå´Ô∏è", color: "#555", weight: 4000 },
            { id: 3, name: "PEDANG BESI", tier: 1, baseVal: 50, emoji: "‚öîÔ∏è", color: "#a0a0a0", weight: 2000 },
            { id: 4, name: "JUBAH BAYANGAN", tier: 1, baseVal: 50, emoji: "üß•", color: "#a0a0a0", weight: 2000 },
            { id: 5, name: "KRISTAL ES", tier: 2, baseVal: 1000, emoji: "‚ùÑÔ∏è", color: "#a5f2f3", weight: 1000 }, 
            { id: 6, name: "TULANG KUNO", tier: 2, baseVal: 1500, emoji: "ü©ª", color: "#e5e5e5", weight: 1000 },
            { id: 7, name: "TOPI PENYIHIR", tier: 3, baseVal: 3000, emoji: "üßô‚Äç‚ôÄÔ∏è", color: "#d946ef", weight: 300 },
            { id: 8, name: "ORB DARKNESS", tier: 3, baseVal: 4000, emoji: "üîÆ", color: "#3b82f6", weight: 300 },
            { id: 9, name: "PHOENIX API", tier: 4, baseVal: 50000, emoji: "üê¶‚Äçüî•", color: "#ff8c00", weight: 80 },
            { id: 10, name: "DRAGON", tier: 5, baseVal: 1000000, emoji: "üêâ", color: "#00ff00", weight: 10 },
            { id: 11, name: "THE JOKER", tier: 6, baseVal: 5000000, emoji: "üÉè", color: "#a855f7", weight: 1 }
        ];

        let state = { user: "", cash: 0, coins: 1000, items: [] };
        let temp = { spinning: false, boost: false, luck: false, muted: false, pendingTx: null };
        let actx = null;
        let masterGain = null;

        // ===== VISUAL FX =====
        const pCanvas = document.getElementById('particleCanvas');
        const lCanvas = document.getElementById('lightningCanvas');
        const pCtx = pCanvas.getContext('2d');
        const lCtx = lCanvas.getContext('2d');
        let particles = [];

        function resizeCanvas() {
            pCanvas.width = window.innerWidth; pCanvas.height = window.innerHeight;
            lCanvas.width = window.innerWidth; lCanvas.height = window.innerHeight;
        }
        window.onresize = resizeCanvas;

        class Particle {
            constructor() { this.reset(); this.y = Math.random() * pCanvas.height; }
            reset() { this.x = Math.random() * pCanvas.width; this.y = pCanvas.height + 10; this.speed = Math.random() * 0.5 + 0.2; this.size = Math.random() * 2; this.opacity = Math.random() * 0.5; }
            update() { this.y -= this.speed; if(this.y < -10) this.reset(); }
            draw() { pCtx.fillStyle = `rgba(255,255,255,${this.opacity})`; pCtx.beginPath(); pCtx.arc(this.x, this.y, this.size, 0, Math.PI*2); pCtx.fill(); }
        }
        function initParticles() { resizeCanvas(); for(let i=0; i<50; i++) particles.push(new Particle()); animateParticles(); }
        function animateParticles() { pCtx.clearRect(0,0,pCanvas.width, pCanvas.height); particles.forEach(p=>{p.update(); p.draw();}); requestAnimationFrame(animateParticles); }

        // --- HEBOH DYNAMIC LIGHTNING ---
        function triggerTargetedLightning(reelIndex, color, intensity, type, tier) {
            playSound('thunder');
            
            const dim = document.getElementById('dimOverlay');
            dim.style.backgroundColor = color;
            dim.classList.add('active'); // SELALU GELAP (HENTAKAN)

            // Cek apakah item "DEWA"
            const isHeavies = (tier >= 4) || (type === 'demon' && tier >= 4);
            
            if (isHeavies) {
                setTimeout(() => {
                    dim.classList.remove('active');
                    lCtx.clearRect(0,0,lCanvas.width,lCanvas.height);
                }, 1500);
            } else {
                // Low Tier: KEDIP CEPAT (0.1s)
                setTimeout(() => {
                    dim.classList.remove('active');
                }, 100); 
            }

            let flash = 1.0;
            const reel = document.getElementById(`reel${reelIndex}`);
            const rect = reel.getBoundingClientRect();
            const startX = window.innerWidth / 2;
            const startY = 0;
            const targetX = rect.left + (rect.width / 2);
            const targetY = rect.top + (rect.height / 2);

            function drawBolt(x1, y1, x2, y2, isCore) {
                if(isCore) {
                    lCtx.lineWidth = Math.max(2, intensity / 2); 
                    lCtx.strokeStyle = "#ffffff"; 
                    lCtx.shadowBlur = 10; lCtx.shadowColor = "#ffffff";
                } else {
                    lCtx.lineWidth = intensity; 
                    lCtx.strokeStyle = color;
                    lCtx.shadowBlur = intensity * 8; lCtx.shadowColor = color;
                }
                lCtx.lineCap = 'round';
                lCtx.beginPath(); lCtx.moveTo(x1, y1);
                let cx = x1, cy = y1;
                const dist = Math.sqrt(Math.pow(x2-x1,2) + Math.pow(y2-y1,2));
                const steps = dist / 12; 
                const dx = (x2-x1)/steps; const dy = (y2-y1)/steps;
                for(let i=0; i<steps; i++) {
                    let noise = (type === 'glitch') ? 60 : 30; 
                    cx += dx + (Math.random()*noise - (noise/2));
                    cy += dy + (Math.random()*noise - (noise/2));
                    lCtx.lineTo(cx, cy);
                    if(!isCore && Math.random() > 0.6) { lCtx.lineTo(cx + (Math.random()*100-50), cy + 80); lCtx.moveTo(cx, cy); }
                }
                lCtx.lineTo(x2, y2); lCtx.stroke();
            }

            function anim() {
                lCtx.clearRect(0,0,lCanvas.width,lCanvas.height);
                if(flash <= 0) { 
                    if(!isHeavies) document.getElementById('dimOverlay').classList.remove('active');
                    return; 
                }
                drawBolt(startX, startY, targetX, targetY, false);
                drawBolt(startX, startY, targetX, targetY, true);
                if (type === 'demon' || type === 'glitch') if(Math.random()>0.3) drawBolt(startX+40, startY, targetX+30, targetY, false);

                lCtx.fillStyle = "#ffffff"; lCtx.shadowColor = color; lCtx.shadowBlur = 60; 
                lCtx.globalAlpha = flash * 0.8;
                lCtx.beginPath(); lCtx.arc(targetX, targetY, intensity * 10, 0, Math.PI*2); lCtx.fill();
                lCtx.globalAlpha = 1;

                flash -= 0.06;
                requestAnimationFrame(anim);
            }
            anim();
        }

        // ===== AUDIO ENGINE =====
        let winTimeout = null; 
        
        // --- VOLUME SETTINGS ---
        const BASE_BGM_VOL = 0.8; // BGM 80%
        const SFX_GAIN = 0.8; // SPIN 80% (SESUAI REQUEST)

        function playChord(freqs, type, dur) {
            if(!actx) return;
            const t = actx.currentTime;
            freqs.forEach(f => {
                const o = actx.createOscillator(); const g = actx.createGain();
                o.type = type; o.frequency.value = f;
                g.gain.setValueAtTime(0.5, t); g.gain.exponentialRampToValueAtTime(0.01, t + dur);
                o.connect(g); g.connect(masterGain); o.start(); o.stop(t + dur);
            });
        }

        function playSound(type, param) {
            if(temp.muted) return;
            if(actx && actx.state==='suspended') actx.resume();
            
            // --- WIN SOUND (DOUBLE IMPACT - 2 PLAYER) ---
            if (type === 'win') {
                const el = document.getElementById('winAudio');
                const el2 = document.getElementById('winAudio2');
                
                // RESET TOTAL (FIX CONSECUTIVE BUG)
                if (winTimeout) clearTimeout(winTimeout);
                el.currentTime = 0; el2.currentTime = 0;
                el.volume = 1.0; el2.volume = 1.0; 
                
                el.play().catch(e=>{});
                el2.play().catch(e=>{});

                const tier = param.tier;
                const mut = param.mut;
                const isHighEnd = (tier >= 4 || mut >= 2);

                if (!isHighEnd) {
                    // LOW TIER: CUT HALUS (FADE OUT) SETELAH 2.5 Detik
                    winTimeout = setTimeout(() => {
                        let vol = 1.0;
                        let fade = setInterval(() => {
                            vol -= 0.1;
                            if (vol <= 0) {
                                clearInterval(fade);
                                el.pause(); el2.pause();
                            } else {
                                el.volume = vol; el2.volume = vol;
                            }
                        }, 50); 
                    }, 2500); 
                }
                return;
            }

            // --- THUNDER SOUND (DOUBLE IMPACT - 2 PLAYER) ---
            if (type === 'thunder') {
                const el = document.getElementById('thunderAudio');
                const el2 = document.getElementById('thunderAudio2');
                el.currentTime = 0; el2.currentTime = 0;
                el.play().catch(e=>{});
                el2.play().catch(e=>{});
                return;
            }

            // --- REEL STOP SOUND (TUNG - TRIANGLE - 100%) ---
            if (type === 'reelStop') {
                const o = actx.createOscillator();
                const g = actx.createGain();
                o.connect(g); g.connect(masterGain);
                
                // SUARA TUNG (Bulat & Bersih)
                o.type = 'triangle';
                o.frequency.setValueAtTime(200, actx.currentTime);
                o.frequency.exponentialRampToValueAtTime(50, actx.currentTime + 0.15);
                g.gain.setValueAtTime(1.0, actx.currentTime); // 100% Volume
                g.gain.exponentialRampToValueAtTime(0.01, actx.currentTime + 0.15);
                
                o.start(); o.stop(actx.currentTime + 0.15);
                return;
            }

            if(!actx) return;
            const t = actx.currentTime;

            // SPIN & BOOST (GAIN 0.9 - 90%)
            if (type === 'spin') { const o = actx.createOscillator(); const g = actx.createGain(); o.connect(g); g.connect(masterGain); o.type = 'sine'; o.frequency.setValueAtTime(200, t); o.frequency.linearRampToValueAtTime(600, t+0.1); g.gain.setValueAtTime(SFX_GAIN, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.1); o.start(); o.stop(t+0.1); }
            else if (type === 'boost') { const o = actx.createOscillator(); const g = actx.createGain(); o.connect(g); g.connect(masterGain); o.type = 'sawtooth'; o.frequency.setValueAtTime(220, t); o.frequency.linearRampToValueAtTime(880, t+0.1); g.gain.setValueAtTime(0.5, t); g.gain.linearRampToValueAtTime(0, t+0.1); o.start(); o.stop(t+0.1); }
            else if (type === 'mut') { const o = actx.createOscillator(); const g = actx.createGain(); o.connect(g); g.connect(masterGain); if (param === 3) { o.type = 'triangle'; o.frequency.setValueAtTime(200, t); o.frequency.exponentialRampToValueAtTime(40, t+4.0); g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(3.0, t+0.1); g.gain.exponentialRampToValueAtTime(0.01, t+4.0); o.start(); o.stop(t+2.0); } else if (param === 2) { o.type = 'square'; o.frequency.setValueAtTime(300, t); g.gain.setValueAtTime(0.2, t); g.gain.exponentialRampToValueAtTime(0.01, t+2.0); o.frequency.linearRampToValueAtTime(100, t+0.1); o.frequency.linearRampToValueAtTime(100, t+0.2); o.start(); o.stop(t+3.0); } else if (param === 1) { o.type = 'sine'; o.frequency.setValueAtTime(400, t); g.gain.setValueAtTime(0.4, t); g.gain.exponentialRampToValueAtTime(0.01, t+2.0); o.start(); o.stop(t+3.0); } } 
            else if (type === 'tier') { if (param <= 1) playChord([261.6], 'sine', 0.2); else if (param === 2) playChord([261.6, 329.6], 'sine', 0.4); else if (param === 3) playChord([261.6, 329.6, 392.0], 'triangle', 0.6); else if (param >= 4) { let notes = [261.6, 329.6, 392.0, 523.2]; notes.forEach((freq, i) => { setTimeout(() => playChord([freq], 'triangle', 0.5), i * 150); }); } }
        }

        // ===== PING-PONG GAPLESS ENGINE (INFINITY FIX - INTERVAL BASED) =====
        let currentBGM = 1;
        const bgm1 = document.getElementById('bgm1');
        const bgm2 = document.getElementById('bgm2');
        const SWAP_TIME = 68.0; 

        // MONITOR LOOP YANG LEBIH BANDEL (SET INTERVAL)
        function startPingPong() {
            bgm1.volume = BASE_BGM_VOL;
            bgm2.volume = BASE_BGM_VOL;
            
            bgm2.muted = true; 
            bgm2.play().then(() => { bgm2.pause(); bgm2.muted=false; bgm2.currentTime=0; });

            bgm1.play().catch(e => console.log("BGM Start blocked"));
            
            // PAKAI SET INTERVAL AGAR TIDAK MATI OLEH VISUAL
            setInterval(monitorPingPong, 100); 
        }

        function monitorPingPong() {
            let active = currentBGM === 1 ? bgm1 : bgm2;
            let next = currentBGM === 1 ? bgm2 : bgm1;

            // CEK JIKA MUSIK MATI SENDIRI (BUG BROWSER), NYALAKAN LAGI
            if (active.paused && active.currentTime > 0 && active.currentTime < SWAP_TIME) {
                active.play().catch(()=>{});
            }

            if (active.currentTime >= SWAP_TIME) {
                next.currentTime = 0;
                next.volume = BASE_BGM_VOL;
                next.play().catch(e => console.log("Swap blocked", e));
                
                setTimeout(() => {
                    active.pause();
                    active.currentTime = 0;
                }, 100); 
                
                currentBGM = currentBGM === 1 ? 2 : 1;
            }
        }
        
        function startGame() { 
            document.getElementById('startScreen').style.display = 'none'; 
            document.getElementById('loginScreen').style.display = 'flex'; 
            actx = new (window.AudioContext || window.webkitAudioContext)(); 
            masterGain = actx.createGain(); masterGain.gain.value = 1.0; 
            masterGain.connect(actx.destination); actx.resume(); 
            initParticles(); 
            startPingPong(); 
        }

        // ===== GAME LOGIC =====
        function getPrice(item, mut) { if(item.id === 11) { if(mut === 3) return 5000000; if(mut === 2) return 2000000; if(mut === 1) return 1000000; return item.baseVal; } if(item.id === 10) { if(mut === 3) return 1500000; if(mut === 2) return 500000; if(mut === 1) return 150000; return item.baseVal; } let bonus = 0; if(mut===3)bonus=30; if(mut===2)bonus=20; if(mut===1)bonus=10; return item.baseVal + bonus; }
        function doLogin() { const u = document.getElementById('username').value.trim(); if(!u) return alert("ISI USERNAME!"); state.user = u; const s = localStorage.getItem('casino_legend_v_final_' + u); if(s) { try { const p = JSON.parse(s); state.cash=p.cash||0; state.coins=p.coins||1000; state.items=p.items||[]; alert("DATA LAMA DIMUAT!"); } catch(e){} } document.getElementById('loginScreen').style.display='none'; initSlots(); updateUI(); renderShop(); }
        function save() { if(state.user) localStorage.setItem('casino_legend_v_final_' + state.user, JSON.stringify(state)); }
        const STRIP_LEN = 30;
        function initSlots() { [1,2,3].forEach(id=>{ document.getElementById(`strip${id}`).innerHTML = generateStripHtml(); }); }
        function generateStripHtml(targetItem=null) { let h = ''; for(let i=0; i<STRIP_LEN; i++) { if(targetItem && i === STRIP_LEN - 4) { h += `<div class="slot-icon" data-id="${targetItem.id}">${targetItem.emoji}</div>`; } else { const r = ITEMS[Math.floor(Math.random()*ITEMS.length)]; h += `<div class="slot-icon" style="opacity:0.4; filter:grayscale(1);">${r.emoji}</div>`; } } return h; }
        
        function resetVisuals() { document.getElementById('dimOverlay').classList.remove('active'); lCtx.clearRect(0,0,lCanvas.width,lCanvas.height); document.getElementById('machineBody').classList.remove('god-active'); }

        async function spinSequence(count) {
            if(temp.spinning) return;
            resetVisuals(); 
            const cost = (count*100) + (temp.boost?5000:0);
            if(state.coins < cost) return alert("KOIN KURANG!");
            state.coins -= cost; updateUI(); temp.spinning = true;
            document.getElementById('spin1').disabled = true; document.getElementById('spin5').disabled = true;
            let sessionResults = [];
            for(let i=0; i<count; i++) {
                if(i > 0) { resetVisuals(); await new Promise(r=>setTimeout(r, 200)); } 
                const item = roll(); sessionResults.push(item);
                const isGod = (item.tier >= 5 || item.mut >= 2);
                await runSlotAnimation(item, isGod);
                if(isGod) { await showJackpotPopup(item); } else { await new Promise(r=>setTimeout(r, 200)); }
            }
            showRes(sessionResults);
            temp.spinning = false; document.getElementById('spin1').disabled = false; document.getElementById('spin5').disabled = false; save();
        }

        function roll() { let pool = JSON.parse(JSON.stringify(ITEMS)); if(temp.luck) { pool = pool.filter(i => i.tier >= 4); pool.forEach(i => i.weight = 100); } else if(temp.boost) pool.forEach(i=>{if(i.tier>=2)i.weight*=5}); let tot=pool.reduce((a,b)=>a+b.weight,0); let r=Math.random()*tot; let it=pool[0]; for(let p of pool) { if(r<p.weight){it=p;break;} r-=p.weight; } let mut=0; let rm=Math.random(); if(temp.luck) { if(rm < 0.4) mut=3; else if(rm < 0.7) mut=2; else mut=1; } else if(it.tier>=1) { if(rm<0.02) mut=3; else if(rm<0.08) mut=2; else if(rm<0.2) mut=1; } return {...it, mut, val: getPrice(it, mut), uid:Date.now()+Math.random()}; }

        function runSlotAnimation(targetItem, isGod) {
            return new Promise(resolve => {
                const isAlign = isGod || (targetItem.tier >= 2) || (targetItem.mut > 0);
                [1,2,3].forEach(id=>{ let visualTarget = targetItem; if (!isAlign && id > 1) visualTarget = ITEMS[Math.floor(Math.random() * ITEMS.length)]; const s = document.getElementById(`strip${id}`); s.innerHTML = generateStripHtml(visualTarget); s.style.transition = 'none'; s.style.transform = `translateY(0px)`; });
                void document.body.offsetWidth;
                const STOP_Y = -1 * ((STRIP_LEN - 5) * 140); 
                let finished = 0;
                [1,2,3].forEach((id, idx) => {
                    const dur = 1.5 + (idx*0.5);
                    setTimeout(() => {
                        const s = document.getElementById(`strip${id}`); s.querySelectorAll('.slot-icon').forEach(e=>e.classList.add('blur-spin')); s.style.transition = `transform ${dur}s cubic-bezier(0.1, 0.9, 0.2, 1)`; s.style.transform = `translateY(${STOP_Y}px)`; const tick = setInterval(()=>playSound('spin'), 100);
                        s.addEventListener('transitionend', () => {
                            clearInterval(tick); 
                            s.querySelectorAll('.slot-icon').forEach(e=>e.classList.remove('blur-spin')); 
                            s.style.transition = "transform 0.2s"; 
                            s.style.transform = `translateY(${STOP_Y + 15}px)`; 
                            setTimeout(()=>{ s.style.transform = `translateY(${STOP_Y}px)`; }, 100);
                            
                            // PLAY SOUND PER REEL STOP (JEG - GAIN 1.0)
                            let currentItem = (isAlign || id===1) ? targetItem : {tier:0}; 
                            playSound('reelStop', currentItem);

                            if(isAlign) {
                                let boltColor = '#ffffff'; let intensity = 2; let type = 'normal';
                                if(targetItem.mut === 3) { boltColor = '#ff003c'; intensity = 10; type = 'demon'; } 
                                else if(targetItem.mut === 2) { boltColor = '#00ffff'; intensity = 6; type = 'glitch'; } 
                                else if(targetItem.mut === 1) { boltColor = '#ffffff'; intensity = 5; type = 'shiny'; } 
                                else if(targetItem.tier >= 6) { boltColor = '#a855f7'; intensity = 8; } 
                                else if(targetItem.tier === 5) { boltColor = '#00ff00'; intensity = 7; } 
                                else if(targetItem.tier === 4) { boltColor = '#ff8c00'; intensity = 6; } 
                                
                                triggerTargetedLightning(id, boltColor, intensity, type, targetItem.tier); 
                                playSound('win', targetItem); 
                            }
                            if(isGod && id===3) { document.getElementById('machineBody').classList.add('god-active'); document.getElementById('machineBody').style.setProperty('--target-color', targetItem.color); }
                            finished++; if(finished === 3) setTimeout(resolve, isGod ? 1500 : 300);
                        }, {once:true});
                    }, idx * 150);
                });
            });
        }

        // --- FORCE RESTART MUSIC AFTER SPECIAL ---
        function ensureBGM() {
            let active = currentBGM === 1 ? bgm1 : bgm2;
            if(active.paused) active.play().catch(()=>{});
        }

        function showJackpotPopup(item) { return new Promise(resolve => { jackpotPromiseResolver = resolve; const pop = document.getElementById('jackpotPopup'); const cont = document.getElementById('jackpotCont'); const title = document.getElementById('jackpotTitle'); cont.innerHTML = ''; const card = createCard(item); card.classList.add('jackpot-card'); cont.appendChild(card); title.innerText = item.mut === 3 ? "DEMON MUTATION!" : "GOD TIER FOUND!"; title.style.color = item.color; pop.style.display = 'flex'; playSound('thunder'); playSound('mut', item.mut); }); }
        
        function closeJackpot() { 
            document.getElementById('jackpotPopup').style.display = 'none'; 
            resetVisuals(); 
            ensureBGM(); // SAFETY KICKSTARTER
            if(jackpotPromiseResolver) jackpotPromiseResolver(); 
        }
        
        async function showRes(items) { const lay = document.getElementById('resultLayer'); const track = document.getElementById('cardTrack'); lay.style.display='flex'; track.innerHTML=''; for(let i=0; i<items.length; i++) { const item = items[i]; state.items.push(item); const el = createCard(item); track.appendChild(el); el.scrollIntoView({behavior:'smooth', inline:'center'}); await new Promise(r=>setTimeout(r,150)); el.classList.add('active'); if(item.mut > 0) playSound('mut', item.mut); else playSound('tier', item.tier); await new Promise(r=>setTimeout(r,200)); } }
        
        function closeResult() { 
            document.getElementById('resultLayer').style.display='none'; 
            resetVisuals(); 
            updateUI(); 
            ensureBGM(); // SAFETY KICKSTARTER
        }

        function createCard(item) { const div = document.createElement('div'); let cls = 'card'; let label = ""; let color = item.color; if(item.mut===3) { cls+=' fx-demon'; label="DEMON"; color='var(--demon)'; } else if(item.mut===2) { cls+=' fx-glitch'; label="GLITCH"; color='var(--glitch)'; } else if(item.mut===1) { cls+=' fx-shiny'; label="SHINY"; color='#fff'; } else if(item.tier>=4) cls+=' t-dragon'; div.className = cls; div.style.setProperty('--glow', item.mut > 0 ? color : item.color); div.innerHTML = `<div class="card-img" style="text-shadow:0 0 20px ${item.color}">${item.emoji}</div><div class="card-name" style="color:${item.mut > 0 ? '#fff' : item.color}">${item.name}</div><div style="font-size:0.7rem; color:#aaa; margin-top:5px;">Val: ${item.val.toLocaleString()}</div>${label ? `<div class="mut-badge" style="background:${color}; color:${item.mut===3?'#fff':'#000'}">${label}</div>` : ''}`; return div; }
        function toggleBoost() { temp.boost=!temp.boost; document.getElementById('btnBoost').classList.toggle('active'); document.getElementById('machineBody').classList.toggle('boost-active'); playSound('boost'); }
        function toggleMute() { alert("Volume diatur dari HP!"); }
        function updateUI() { document.getElementById('uiCash').innerText=state.cash.toLocaleString(); document.getElementById('uiCoins').innerText=state.coins.toLocaleString(); }
        function showModal(id) { document.getElementById(id).style.display='flex'; }
        function hideModal(id) { document.getElementById(id).style.display='none'; }
        function buy(t, g, c) { temp.pendingTx = { type: t, gain: g, cost: c }; const msg = t === 'coin' ? `BELI <span style="color:var(--gold)">${g.toLocaleString()} KOIN</span><br>HARGA: <span style="color:#4ade80">Rp ${c.toLocaleString()}</span>` : `TOP UP SALDO<br><span style="color:#4ade80">Rp ${c.toLocaleString()}</span>`; document.getElementById('confirmMsg').innerHTML = msg; document.getElementById('confirmModal').style.display = 'flex'; }
        function processTransaction() { const tx = temp.pendingTx; if(!tx) return; if(tx.type === 'coin') { if(state.cash < tx.cost) { alert("SALDO KURANG!"); closeConfirm(); return; } state.cash -= tx.cost; state.coins += tx.gain; } else { state.cash += tx.gain; } updateUI(); save(); playSound('tier', 1); closeConfirm(); }
        function closeConfirm() { document.getElementById('confirmModal').style.display = 'none'; temp.pendingTx = null; }
        function openInv(filter) { document.getElementById('invModal').style.display='flex'; const g = document.getElementById('invGrid'); g.innerHTML=''; let list = [...state.items].sort((a,b) => { if(b.tier !== a.tier) return b.tier - a.tier; return b.mut - a.mut; }); if(filter==='mutant') list = list.filter(i=>i.mut>0); list.forEach(i => { const el = document.createElement('div'); let cls = 'inv-card'; if(i.mut===3) cls+=' fx-demon'; else if(i.mut===2) cls+=' fx-glitch'; else if(i.mut===1) cls+=' fx-shiny'; el.className = cls; el.style.borderColor = i.color; el.style.setProperty('--glow', i.color); el.onclick = () => inspectItem(i); el.innerHTML = `<div class="card-img" style="font-size:35px; margin:0; text-shadow:0 0 10px ${i.color}">${i.emoji}</div><div class="card-name" style="color:${i.color}; font-size:0.7rem; margin-top:5px;">${i.name}</div>`; g.appendChild(el); }); }
        function inspectItem(item) { const over = document.getElementById('previewOverlay'); const cont = document.getElementById('previewCont'); const actions = document.getElementById('sellActions'); cont.innerHTML = ''; actions.innerHTML = ''; const card = createCard(item); card.classList.add('active'); cont.appendChild(card); const btn = document.createElement('button'); btn.className = 'btn-act'; btn.style.cssText = "background:#d00; padding:10px 20px; border:2px solid #fff; z-index:999;"; btn.innerHTML = `JUAL (üíµ ${item.val.toLocaleString()})`; btn.onclick = (e) => { e.stopPropagation(); sellSingle(item); }; actions.appendChild(btn); over.style.display = 'flex'; if(item.mut > 0) playSound('mut', item.mut); else playSound('tier', item.tier); }
        function closePreview() { document.getElementById('previewOverlay').style.display='none'; }
        function sellSingle(item) { if(!confirm("Jual item ini?"))return; state.items = state.items.filter(i => i.uid !== item.uid); state.cash += item.val; updateUI(); save(); playSound('tier', 1); closePreview(); openInv('all'); }
        function sellTrash() { const trash = state.items.filter(i=>i.tier===0 && i.mut===0); const val = trash.reduce((a,b)=>a+b.val,0); if(val>0) { if(!confirm(`JUAL SEMUA SAMPAH SEHARGA ${val}?`)) return; state.items = state.items.filter(i=>i.tier>0 || i.mut>0); state.cash+=val; updateUI(); save(); openInv('all'); } else alert("TIDAK ADA SAMPAH"); }
        function renderShop() { const cList=[{g:300,c:10000},{g:1000,c:20000},{g:1500,c:26000},{g:2500,c:40000},{g:5100,c:80000},{g:10300,c:160000},{g:20600,c:320000},{g:350000,c:5000000}]; const sList=[10000,25000,50000,80000,100000,200000,350000,500000,1000000,5000000]; document.getElementById('coinGrid').innerHTML = cList.map(o=>`<div class="shop-item" onclick="buy('coin',${o.g},${o.c})"><div>ü™ô</div><div>${o.g.toLocaleString()}</div><div style="color:var(--gold)">${o.c.toLocaleString()}</div></div>`).join(''); document.getElementById('cashGrid').innerHTML = sList.map(v=>`<div class="shop-item" onclick="buy('cash',${v},${v})"><div>üíµ</div><div>${v.toLocaleString()}</div><div style="color:#4ade80">Rp ${v.toLocaleString()}</div></div>`).join(''); }
        function redeem() { const c = document.getElementById('codeInput').value.toUpperCase(); if(c==='ENGGACOR') state.cash+=100000000; else if(c==='POTIONDARIENG') { temp.luck=true; document.getElementById('luckStatus').style.display='flex'; document.getElementById('machineBody').classList.add('glow-demon'); playSound('mut', 3); setTimeout(()=>{temp.luck=false;document.getElementById('luckStatus').style.display='none';document.getElementById('machineBody').classList.remove('glow-demon')},60000); } updateUI(); save(); }
    </script>
</body>
</html>
